name: Release Charts

on:
  push:
    tags:
      - v*
    branches:
      - master

jobs:
  create_release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Make version

        id: vars
        run: |
          echo "::set-output name=version::$(make version)"
          echo "::set-output name=release_tag::${GITHUB_REF/refs\/tags\//}"

      - name: Create asset
        id: asset
        run: |
          ARCHIVE_NAME=csi-baremetal-operator-${{ steps.vars.outputs.version }}.tgz
          tar -czvf ./$ARCHIVE_NAME charts
          echo "::set-output name=archive_name::$ARCHIVE_NAME"

      - name: Upload asset
        uses: actions/upload-artifact@v2
        with:
          name: ${{ steps.asset.outputs.archive_name }}
          path: ./${{ steps.asset.outputs.archive_name }}

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Release ${{ github.ref }}
          draft: false
          prerelease: true
          files: ./${{ steps.asset.outputs.archive_name }}
        if: startsWith(github.ref, 'refs/tags/')

      - name: Trigger release workflow in csi-baremetal repo and wait the result
        uses: convictional/trigger-workflow-and-wait@v1.3.0
        with:
          owner: misanthropicat
          repo: csi-baremetal
          workflow_file_name: release.yml
          ref: master
          github_token: ${{ secrets.CSI_WF_TOKEN }}
          inputs: '{ "csi_operator_version": "${{ steps.vars.outputs.version }}", "release_tag":  "${{ steps.vars.outputs.release_tag }}"}'
          wait_interval: 5
        if: startsWith(github.ref, 'refs/tags/')

      - name: Download asset
        uses: actions/download-artifact@v2
        with:
          name: csi-baremetal-deployment-${{ steps.vars.outputs.version }}.tgz
        if: startsWith(github.ref, 'refs/tags/')

      - name: Check assets in working directory
        run: ls | grep tgz

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
